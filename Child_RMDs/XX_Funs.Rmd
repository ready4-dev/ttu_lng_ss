---
title: "MA_Results"
author: "Matthew Hamilton"
date: "13/10/2020"
output: html_document
---
```{r echo = F}
library(officedown)
library(TTU)
```
```{r}
# get_prefd_mdl_predrs <- function(results_ls){
#   predrs_1L_chr <- results_ls$predr_var_nms_chr %>% 
#     paste0(collapse = ", ") %>% 
#     stringi::stri_replace_last(fixed = ",", " and")
#   return(predrs_1L_chr)
# }
# get_selected_mixed_mdls <- function(results_ls,
#                                     collapse_1L_lgl = T){
#   mixed_mdls_xx <- results_ls$ttu_lngl_ls$best_mdls_tb %>% purrr::pmap_chr(~paste0(..1," (",..2,")"))  
#   if(collapse_1L_lgl){
#     mixed_mdls_xx <- mixed_mdls_xx  %>% 
#       paste0(collapse = ", ") %>% 
#       stringi::stri_replace_last(fixed = ",", " and")
#   }
#  return(mixed_mdls_xx)
# }
# make_covar_ttu_tbl_refs <- function(params_ls){
#   results_ls <- params_ls$results_ls
#   n_mdls_1L_int <- length(results_ls$ttu_lngl_ls$best_mdls_tb$model_type)
#   n_covars_1L_int <- length(results_ls$ttu_lngl_ls$incld_covars_chr)
#   text_1L_chr <- paste0(ifelse(n_covars_1L_int < 1,
#                                "",
#                                paste0(" (see ",
#                                       ifelse(params$output_type_1L_chr=="Word","","Table"),
#                                       "s ",
#                                       paste0("\\@ref(tab:coefscovarstype",1:n_mdls_1L_int,")", collapse = ", ") %>%
#                           stringi::stri_replace_last(fixed = ",", " and"),
#                           ")"
#                                         ))
#   )
#   return(text_1L_chr)
# }
# make_indpnt_predrs_lngl_tbls_ref <- function(params_ls){
#   results_ls <- params_ls$results_ls
#   n_mdls_1L_int <- length(results_ls$ttu_lngl_ls$best_mdls_tb$model_type)
#   text_1L_chr <- paste0(ifelse(params$output_type_1L_chr=="Word","","Table"),
#                         ifelse(n_mdls_1L_int < 3,
#                                " \\@ref(tab:cfscl)",
#                                paste0("s ",
#                                       paste0("\\@ref(tab:cfscl",1:n_mdls_1L_int,")", collapse = ", ") %>%
#                           stringi::stri_replace_last(fixed = ",", " and")
#                                         ))
#   )
#   return(text_1L_chr)
# }
# make_indpnt_predrs_lngl_tbl_title <- function (results_ls, ref_1L_int = 1) 
# {
#     title_1L_chr <- paste0("Estimated coefficients for single predictor longitudinal TTU models using ", 
#  results_ls$ttu_lngl_ls$best_mdls_tb[[ref_1L_int, 
#             "model_type"]], " (", results_ls$ttu_lngl_ls$best_mdls_tb[[ref_1L_int, 
#             "link_and_tfmn_chr"]], ")")
#     return(title_1L_chr)
# }
# make_scaling_text <- function(results_ls,
#                               table_1L_chr = "cfscl"){
#   if(startsWith(table_1L_chr,"cfscl")){
#     table_df <- results_ls$tables_ls$ind_preds_coefs_tbl
#   }else{
#     if(startsWith(table_1L_chr,"coefscovarstype")){
#       table_df <- results_ls$tables_ls %>%
#         purrr::pluck(paste0("mdl_type_",
#              table_1L_chr %>% stringr::str_remove("coefscovarstype"),
#              "_covar_mdls_tb"))
#     }
#   }
#   predrs_chr <- table_df$Parameter %>% setdiff(c("SD (Intercept)","Intercept")) %>% stringr::str_replace_all(" model","") %>% stringr::str_replace_all(" baseline","") %>% stringr::str_replace_all(" change","") %>% unique()
#   predrs_lup <- results_ls$mdl_ingredients_ls$predictors_lup %>%
#     dplyr::filter(short_name_chr %in% predrs_chr)
#   scaling_dbl <- predrs_lup$mdl_scaling_dbl %>% unique()
#   text_1L_chr <- ifelse(all(scaling_dbl==1),
#                         "",
#                         paste0("Note: ",
# 
#                                scaling_dbl %>%
#                                  purrr::map_chr(~ {
#                                    scaled_predrs_chr <- predrs_lup %>%
#                                      dplyr::filter(mdl_scaling_dbl == .x) %>%
#                                      dplyr::pull(short_name_chr) %>%
#                                      sort()
#                                    ifelse(.x ==1,
#                                           "",
#                                           paste0("The ",
#                                                  scaled_predrs_chr %>%
#                                                    paste0(collapse = ", ") %>%
#                                                    stringi::stri_replace_last(fixed = ",", " and"),
#                                                  " parameter",
#                                                  ifelse(length(scaled_predrs_chr) == 1,
#                                                         " was",
#                                                         "s were"),
#                                                  " first multiplied by ",
#                                                  .x,
#                                                  "."))
#                                  }
#                                  ) %>%
#                                  paste0(collapse = " ")))
#   return(text_1L_chr)
# }
# print_indpnt_predrs_lngl_mdl_coefs <- function(params_ls, 
#                                                caption_1L_chr,
#                                                ref_1L_int = 1,
#                                                table_1L_chr){
#     results_ls <- params_ls$results_ls
#     mdl_type_1L_chr <- results_ls$mdl_ingredients_ls$mdls_lup$mdl_type_chr %>% 
#       unique() %>%
#       purrr::pluck(ref_1L_int)
#     tb <- results_ls$tables_ls$ind_preds_coefs_tbl %>%
#       dplyr::select(Parameter, names(.) %>% 
#                       purrr::keep(~{
#                         endsWith(.x,mdl_type_1L_chr)})) %>%
#       dplyr::rename_with(.cols = names(.) %>% 
#                       purrr::keep(~{
#                         endsWith(.x,mdl_type_1L_chr)}), 
#         ~ stringr::str_remove(.x,paste0("_",mdl_type_1L_chr)))
#     tb %>%
#       print_lngl_ttu_tbls(caption_1L_chr = caption_1L_chr,
#                           params_ls = params_ls,
#                           ref_1L_int = ref_1L_int,
#                           table_1L_chr = table_1L_chr)
# }
# print_lngl_ttu_tbls <- function(table_df,
#                                 params_ls,
#                                 caption_1L_chr,
#                                 table_1L_chr,
#                                 ref_1L_int = 1){
#   results_ls <- params_ls$results_ls
#   if(params_ls$output_type_1L_chr == "PDF"){
#     add_to_row_ls <- list()
#     add_to_row_ls$pos <- list(0, nrow(table_df))
#     add_to_row_ls$command <- c("Parameter & Estimate	& SE	& 95CI & R2	& Sigma\\\\\n",
#                                paste0("\\hline\n",
#                                       "{\\footnotesize ",
#                                       make_scaling_text(results_ls,
#                                                         table_1L_chr = knitr::opts_current$get("tab.id")),
#                                       "}\n"))
#     table_df$Parameter <- table_df$Parameter %>% purrr::map_chr(~ifelse(endsWith(.x,
#                                                                      " model"),
#                                                             paste0("\\textbf{",.x,"}"),.x))
#   }else{
#     add_to_row_ls <- NULL
#   }
#   table_df %>%
#     ready4show::print_table(output_type_1L_chr = params_ls$output_type_1L_chr,
#                             caption_1L_chr = caption_1L_chr,
#                             mkdn_tbl_ref_1L_chr = paste0("tab:",table_1L_chr),
#                             use_rdocx_1L_lgl = ifelse(params_ls$output_type_1L_chr=="Word",T,F),
#                             add_to_row_ls = add_to_row_ls,
#                             footnotes_chr = make_scaling_text(results_ls,
#                                                               table_1L_chr = table_1L_chr),
#                             hline_after_ls = c(-1,0),
#                             sanitize_fn = force)
# 
# }
```

