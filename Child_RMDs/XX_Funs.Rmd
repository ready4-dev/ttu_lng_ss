---
title: "MA_Results"
author: "Matthew Hamilton"
date: "13/10/2020"
output: html_document
---
```{r echo = F}
library(officedown)
library(TTU)
```
```{r}
# make_covar_ttu_tbl_title <- function(results_ls,
#                                      ref_1L_int = 1){
#   title_1L_chr <- paste0('Estimated coefficients from longitudinal TTU models based on individual candidate predictors with ',results_ls$ttu_lngl_ls$incld_covars_chr %>% paste0(collapse = ", ") %>% stringi::stri_replace_last(fixed = ",", " and"),' using ', results_ls$ttu_lngl_ls$best_mdls_tb[[ref_1L_int,"model_type"]], ' (', results_ls$ttu_lngl_ls$best_mdls_tb[[ref_1L_int,"link_and_tfmn_chr"]],')')
#   return(title_1L_chr)
#                                      }
# make_ten_folds_tbl_title <- function(results_ls,
#                                      ref_1L_int = 1){
#   title_1L_chr <- ifelse(ref_1L_int == 1,
#                          paste0('10-fold cross-validated model fitting index for different ',
#                          results_ls$ttu_cs_ls$best_mdl_types_ls %>% 
#                            names() %>% 
#                            paste0(collapse = ", ") %>% 
#                            stringi::stri_replace_last(fixed = ",", " and"), 
#                          ' models using ',
#                          results_ls$ttu_cs_ls$cs_mdls_predrs_seq_dscdng_chr[1],
#                          ' as predictor with the baseline data'),
#                          paste0('10-fold cross-validated model fitting index for different candidate predictors estimated using ',
#                                 results_ls$ttu_cs_ls$selected_mdls_chr[1],
#                                 ' with the baseline data'))
#   return(title_1L_chr)
# }
# #
# make_scaling_text <- function(results_ls, ########TEMP DUPLICATE
#                               table_1L_chr = "cfscl"){
#   if(table_1L_chr == "cfscl"){
#     table_df <- results_ls$tables_ls$ind_preds_coefs_tbl
#   }else{
#     if(startsWith(table_1L_chr,"coefscovarstype")){
#       table_df <- results_ls$tables_ls %>%
#         purrr::pluck(paste0("mdl_type_",
#              table_1L_chr %>% stringr::str_remove("coefscovarstype"),
#              "_covar_mdls_tb"))
#     }
#   }
#   predrs_chr <- table_df$Parameter %>% setdiff(c("SD (Intercept)","Intercept")) %>% stringr::str_replace_all(" model","") %>% stringr::str_replace_all(" baseline","") %>% stringr::str_replace_all(" change","") %>% unique()
#   predrs_lup <- results_ls$mdl_ingredients_ls$predictors_lup %>%
#     dplyr::filter(short_name_chr %in% predrs_chr)
#   scaling_dbl <- predrs_lup$mdl_scaling_dbl %>% unique()
#   text_1L_chr <- ifelse(all(scaling_dbl==1),
#                         "",
#                         paste0("Note: ",
# 
#                                scaling_dbl %>%
#                                  purrr::map_chr(~ {
#                                    scaled_predrs_chr <- predrs_lup %>%
#                                      dplyr::filter(mdl_scaling_dbl == .x) %>%
#                                      dplyr::pull(short_name_chr) %>%
#                                      sort()
#                                    ifelse(.x ==1,
#                                           "",
#                                           paste0("The ",
#                                                  scaled_predrs_chr %>%
#                                                    paste0(collapse = ", ") %>%
#                                                    stringi::stri_replace_last(fixed = ",", " and"),
#                                                  " parameter",
#                                                  ifelse(length(scaled_predrs_chr) == 1,
#                                                         " was",
#                                                         "s were"),
#                                                  " first multiplied by ",
#                                                  .x,
#                                                  "."))
#                                  }
#                                  ) %>%
#                                  paste0(collapse = " ")))
#   return(text_1L_chr)
# }
# print_covar_ttu_tbls <- function(params_ls,
#                                  caption_1L_chr,
#                                  table_1L_chr,
#                                  ref_1L_int = 1){
#   results_ls <- params_ls$results_ls
#   df <- results_ls$tables_ls %>%
#     purrr::pluck(paste0("mdl_type_",ref_1L_int,"_covar_mdls_tb")) %>%
#     dplyr::mutate(Parameter = Parameter %>% purrr::map_chr(~stringr::str_replace_all(.x,"_"," ")))
#   if(params_ls$output_type_1L_chr == "PDF"){
#     add_to_row_ls <- list()
#     add_to_row_ls$pos <- list(0, nrow(df))
#     add_to_row_ls$command <- c("Parameter & Estimate	& SE	& 95CI & R2	& Sigma\\\\\n",
#                                paste0("\\hline\n",
#                                       "{\\footnotesize ",
#                                       make_scaling_text(results_ls,
#                                                         table_1L_chr = knitr::opts_current$get("tab.id")),
#                                       "}\n"))
#     df$Parameter <- df$Parameter %>% purrr::map_chr(~ifelse(endsWith(.x,
#                                                                      " model"),
#                                                             paste0("\\textbf{",.x,"}"),.x))
#   }else{
#     add_to_row_ls <- NULL
#   }
#   df %>%
#     ready4show::print_table(output_type_1L_chr = params_ls$output_type_1L_chr,
#                             caption_1L_chr = caption_1L_chr,
#                             mkdn_tbl_ref_1L_chr = paste0("tab:",table_1L_chr),
#                             use_rdocx_1L_lgl = ifelse(params_ls$output_type_1L_chr=="Word",T,F),
#                             add_to_row_ls = add_to_row_ls,
#                             footnotes_chr = make_scaling_text(results_ls,
#                                                               table_1L_chr = table_1L_chr),
#                             hline_after_ls = c(-1,0),
#                             sanitize_fn = force)
# 
# }
```

```{r results = 'asis'}
# Adapted from: https://stackoverflow.com/questions/15036754/r-package-xtable-how-to-create-a-latextable-with-multiple-rows-and-columns-from
get_pkg_citn <- function(pkg_nm_1L_chr){
  citn_chr <- suppressWarnings(citation(pkg_nm_1L_chr)) %>% capture.output()
  start_idx_1L_int <- 4
  end_idx_1L_int <- which(citn_chr== "")[which(which(citn_chr== "")>start_idx_1L_int)[1]]-1
  citn_1L_chr<- citn_chr[start_idx_1L_int:end_idx_1L_int] %>% paste0(collapse = "")
  return(citn_1L_chr)
}
transform_tb_for_merged_col_1 <- function(df,
                                          output_type_1L_chr = "PDF"){
    df[[1]] <- as.character(df[[1]])
    rle.lengths <- rle(df[[1]])$lengths
    first <- !duplicated(df[[1]])
    df[[1]][!first] <- ""
    if(output_type_1L_chr == "PDF")
      df[[1]][first] <- paste0("\\midrule\\multirow{", rle.lengths, "}{*}{\\textbf{", df[[1]][first], "}}")
    return(df)
}
make_bl_fup_add_to_row_ls <-  function(df,
                                       n_at_bl_1L_int,
                                       n_at_fup_1L_int){
  add_to_row_ls <- list(pos = list(-1, nrow(df)),
                        command = c(paste("\\toprule \n",  
                                          paste0("\\multicolumn{2}{c}{} & \\multicolumn{2}{c}{\\textbf{Baseline (N=",n_at_bl_1L_int,")}} & \\multicolumn{2}{c}{\\textbf{Follow-up (N=",n_at_fup_1L_int,")}} \\\\\n")),
                                    paste("\\bottomrule \n"  
                                          )
                                    )
                        )
  return(add_to_row_ls)
}
```

```{r}
# print_table_xx <- function(data_tb,
#                            pdf_output_lgl,
#                            caption_chr,
#                            label,
#                            hline.after,
#                            sanitize.text.function = getOption("xtable.sanitize.text.function", NULL),
#                            addtorow){
#    data_x_tb <- data_tb %>%
#   xtable::xtable(caption = caption_chr, label = label)
# if(pdf_output_lgl){
#  data_x_tb %>%
#   print(comment = F,
#         floating = TRUE, #floating.environment = "sidewaystable",
#         hline.after = hline.after,
#         caption.placement = "top",
#         sanitize.text.function = sanitize.text.function,
#         add.to.row = addtorow, 
#         include.colnames = FALSE,
#         include.rownames=FALSE#,scalebox = 0.75
#         ) 
# }else{
#   data_tb %>%
#     kableExtra::kable(escape = F,
#         caption = caption_chr) %>%
#       kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
#                                 full_width = F, 
#                                 position = "left")
# }
# }
```
